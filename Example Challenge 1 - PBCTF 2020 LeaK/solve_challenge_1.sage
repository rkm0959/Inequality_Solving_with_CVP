from sage.modules.free_module_integer import IntegerLattice

# Directly taken from rbtree's LLL repository
# From https://oddcoder.com/LOL-34c3/, https://hackmd.io/@hakatashi/B1OM7HFVI
def Babai_CVP(mat, target):
    M = IntegerLattice(mat, lll_reduce=True).reduced_basis
    G = M.gram_schmidt()[0]
    diff = target
    for i in reversed(range(G.nrows())):
        diff -=  M[i] * ((diff * G[i]) / (G[i] * G[i])).round()
    return target - diff


def solve(mat, lb, ub, weight = None):
    num_var  = mat.nrows()
    num_ineq = mat.ncols()

    max_element = 0 
    for i in range(num_var):
        for j in range(num_ineq):
            max_element = max(max_element, abs(mat[i, j]))

    if weight == None:
        weight = num_ineq * max_element

    if len(lb) != num_ineq:
        print("Fail: len(lb) != num_ineq")
        return

    if len(ub) != num_ineq:
        print("Fail: len(ub) != num_ineq")
        return

    for i in range(num_ineq):
        if lb[i] > ub[i]:
            print("Fail: lb[i] > ub[i] at index", i)
            return

    # scaling process begins
    max_diff = max([ub[i] - lb[i] for i in range(num_ineq)])
    applied_weights = []

    for i in range(num_ineq):
        ineq_weight = weight if lb[i] == ub[i] else max_diff // (ub[i] - lb[i])
        applied_weights.append(ineq_weight)
        for j in range(num_var):
            mat[j, i] *= ineq_weight
        lb[i] *= ineq_weight
        ub[i] *= ineq_weight

    # Solve CVP
    target = vector([(lb[i] + ub[i]) // 2 for i in range(num_ineq)])
    result = Babai_CVP(mat, target)

    for i in range(num_ineq):
        if (lb[i] <= result[i] <= ub[i]) == False:
            print("Fail : inequality does not hold after solving")
            break
    
    ## recover your result
    return result, applied_weights

## Example 1 : PBCTF 2020 LeaK 

# data is given in order of h, leak, r, s
data = [(73065259012986296172162600130509405474599075774327589596631188252611047316256, 33964300656368154908463421837005045114399560232738270, 82894354853519526232501734941523543465298626001572857848389304352505207427358, 36490061653005810562190081674168818228310589341963072490906079554169628568132), (30450984996954733791275597605491959526178885437275695501338341866523152633242, 71568795634286892105266740773117872305535663191433771, 30985572706467560535112208834986984525636076513540240199425453868889258718450, 22238336351858085353416040603272761010093785389912572730851373350463009177628), (36084299200833245160393815975668328381407935272700375595862751546268827850829, 90859339930476824816842975847539531351051633452940689, 95547691511932121475627743581846468183885440858023135751833077945915641665631, 106784506093122510181756427206737444451711888563351340360918984868765245224208), (621098717605866262055918940389126162192373933559410590896029103951194315686, 90959741323167907970339487873680991954115408563713225, 47865767068052365663328012166131606247938494812814168713834240375581510798141, 95899257283617795472346335143395960787201083922346604297719466447725025727723), (23606807773889185445551103499556850104978872671315635705508770906133649548348, 80441849940943062379384198806057882393330312124894873, 30934286008406006805187351525685268775266129612075537851490061653267980149863, 18457869929997595150435420811845170056680184766025627789509641879837682367160), (98454794375350670595588849848057841865654971388372303588330235124144313103034, 89890952879853698931425725502522124397244157054214652, 20957328509201369071764760746870031958706880275321867060322960723932528369333, 97912953962792888186538778652110028604731904319179746324840803927069934482248), (51509207120043028671658865683292192724987352158121610133591380170240759119595, 16833776589947632047999214010376137597219689085947240, 107145097135548149185108964798489156467951168013921456346264474140317197092291, 55766346247571022448902172419803626728747674760431840493990470149567906232473), (103388801103569320986057884695057028090388551305845034951980645083633776914221, 8301609756476135573170894455535567268232755475081715, 27874805311401534725386615110141832708981904162564101791326720084348749595216, 30990954125298888694052606635120902068992842107926982005326331652941974051643), (89969906957551946190633208800435926364801247190517764020362518874767845656246, 23316424784406523354907715932426471686035048782704409, 34981000689589527386524994558560604061759398569358325614712300196463703828858, 64108285981327865598725846211969948621446559790883007851604255072933006064862), (94387273459074347891424603573020924337777473587784031038568934177662278518163, 9066766732451191877946507476794538466093754135000831, 66891009849667040416504885684829379150568470034680414805140167733119292783803, 40939167499570752898735779568308978575102723457215746444736678126721356483917), (57255081785909877342311739858734144826564985167769418191770546100734178139022, 53717449398528184622369868753147780090454102083993492, 23659719841501329876943589795816046643165260024769432571607657398569644362093, 88368391722619744751660978995088693026047920931061667212749700509709731806199), (56663610680482008999832994127234443638389308185320278376227503172066712674026, 33412015081086711978604497030640222040045491708429777, 95308989005824755055425653879149406689647055982618927887789915528032557834016, 63466029487375389854942398021214772301863180900287057363659629810789302818161), (114109529930916226703095551553907190499331288821964853761112518989058248602227, 38688671937840268787478633863623034311330321303970160, 52415231581599283624796514437189671957836282704449807127396473709424760852239, 105848503929909160925121515750643171097102455122322448650515375087599193839627), (90309767283035851448314644176853407540275900153267515421450785374634833628858, 628321260634938982869025703429495475937484114686788, 67849984289605760977782817332586119886568960506249272733571405131409810358215, 80950993081512785914457196057546884825245583602274183701072639842479110115862), (61698596178679285122774907794734807972374000798775328353769422083285523873799, 1874850590340991676459707511151802504359796969955275, 12775779784340538280076184178778270335749410912051815649824539859649825690679, 11797288785207402035695342032210105289212974959200350810411027879141016496785), (61175964046404140043744416250714734061239872817418520995802455925173097602961, 22280716493522848976884076524261751314938198898148664, 97595909250775255935001516851006785816904214893451723381768451843513994249190, 109856457889349054325255130798038934162450693223870741069934429180984672450223), (47583855623223403290231638707289034881302812538657963378589737943843171441222, 43336442770012144299701827826767247193588238756989129, 95216458311536147994912406899287046290084869095499470086808389609610316100125, 92158540177813221944796482313251046163839073953583354341315686014417452691694), (75821074355965797604707054317476085586097157847267624943052837179333854045146, 42382578071877693489582387579886645664683122606029482, 15896410419620072355833970195357751807570701743799192519697031680558227231592, 68436023768648562516393622605170591178793843463802515122757184868479701169323), (93242430370968816337352624601826520191832478111425916853187937088588994304339, 63404219404345899072849591579618837925519891325288823, 36632517119456647033689792567964980792455139594292669001928969261149008158013, 9233415740859971239903514380410794529482996649309752216895700430267957150444), (114786936617980481194888012221858456163069609158379084902784589263304531791970, 2441379599780606792828068074369263317158840158086801, 8129340069472228581180175780198439268953400478117681179354433751863313504265, 79245836416071401164965959341494079159308247904342258343346054020663466268071), (77231591304252624429602509814437318018450989823767330948780306016760575918762, 30654443197091307944610864864294964533714109922079810, 67435612005563993370976744529162645985911724706055989609439136050680668987547, 45016154848487611592791611851821164153072606305503515349522764594104651005980), (37168183938515207195844376881021329709786540364271177960152474236408320789806, 5727565226352645909078519569821885286501563268347064, 67567337363042970746704245026303526061525198070949995128820188364411793196498, 37451986484301130845230379144988635777710070523765117823998156584143312613037), (68744739571987943977059840733366279639241921586447921588122203196587422744479, 21884620392678970447000022316224131928083007078267113, 45313549972944389560668061495416924394416382850077847247870377141875772267932, 93984967667631675553348458892833490683029954862079710443775858205270832143034), (21567774806957561725348961030455963996102739685072029640566867090687159740982, 48254503747103162768204345113072081691978893516061096, 51064507652182282793406500663329898239217305212305371317877469783456124305850, 40703086445774146575310976468370592710178239241355447388964097717865436215486), (4386370650317256964520331403757743198955025947564820509709462387236358888577, 70118890361264615250155242967808047626173172621765834, 15356553499210396632653252920783493820610541877882024657094013208595205567883, 55432337341302613580005075110551735850006077620939708549067551024732319389730), (105106631798438768406878418094329923074127733718064752474192209978465350269594, 44091529476659479944279068059877901801096172689767404, 78630252818742034872205823216998432607805248240171478373562437245494057626030, 93543279563619667417028771759367384340964823371510091211447674941706510086181), (37255514724827821640824306661403264620990142415607134033290137584367472423588, 5606923573068800564277772224070017263219904410078407, 92788076500336458734532816880849256945908260088042017052624552546206537899122, 60529036117080717912863055636984175576620311435086776790037938074854124458865), (22094520557837757428395820988106108511507651628840273196967929961692424854753, 73320844185855509278555351797771299275864173236423832, 90832072698116709176457507514455021189271776664719728271816258226210210676857, 65599930576650258351968138842026193056897866302130904871544694218954643006164), (44482976894320088173116513040730978942148506438640633002057290913628820741309, 33870199936741270291969120798649736292740080283683599, 55256324162439108227286409622085880453794538850614132365712186312434999048275, 37681615923422697020735753444438840422573578716872622150261209194582296318182), (41842068659515038936230020254814883309195821555594877503924997633306963967868, 94974264925784794571875977018755772829460556811069683, 9806218081808205855066374609875168464792314919147905913932538092706803955249, 687552341529367481203688114250117212424656667729490846453893193584974998922)]

NUM = 10 # number of data to use : higher NUM implies longer calculation time
n = 115792089237316195423570985008687907852837564279074904382605163141518161494337

# ton of mathematics gives you
# r * pvk - 2^216s * small_1 - s * small_2 + n * val = 2^40 * s * leak - h
# 0 <= small_1, small_2 < 2^40, 0 <= pvk < n

# 3 * NUM + 1 variables, (small_1, small_2, val for each equation) and pvk
# 3 * NUM + 1 inequalities, (small_1, small_2, and the large equation) and pvk

# build matrix and lb/ub
M = matrix(ZZ, 3 * NUM + 1, 3 * NUM + 1)

lb = [0] * (3 * NUM + 1)
ub = [0] * (3 * NUM + 1)

for i in range(0, NUM):
    M[0, i] = data[i][2] # pvk
    M[3 * i + 1, i] = - (2 ** 216) * data[i][3] # small_1
    M[3 * i + 2, i] = - data[i][3] # small_2
    M[3 * i + 3, i] = n # val
    tar = ((2 ** 40) * data[i][3] * data[i][1] - data[i][0]) # target
    lb[i] = tar 
    ub[i] = tar

for i in range(0, NUM):
    M[3 * i + 1, NUM + 2 * i] = 1 # small_1 bound
    M[3 * i + 2, NUM + 2 * i + 1] = 1 # small_2 bound
    lb[NUM + 2 * i] = 0
    lb[NUM + 2 * i + 1] = 0
    ub[NUM + 2 * i] = (2 ** 40)
    ub[NUM + 2 * i + 1] = (2 ** 40)

M[0, 3 * NUM] = 1
lb[3 * NUM] = 0
ub[3 * NUM] = n

# solve CVP
res, weights = solve(M, lb, ub)

pvk = res[3 * NUM] // weights[3 * NUM]

print(pvk) # secret key. the rest is trivial.
